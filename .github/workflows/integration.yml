name: Integration Tests

on:
  # No push trigger - CI workflow handles push/PR integration tests
  # This workflow is for comprehensive nightly + manual runs only
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run with tmate debugging'
        required: false
        default: 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  integration-db:
    name: Database Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: valence
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: valence_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: ~/.local/bin/uv pip install -e ".[dev]" --system

      - name: Initialize test database
        env:
          PGHOST: localhost
          PGUSER: valence
          PGPASSWORD: testpass
          PGDATABASE: valence_test
        run: |
          psql -f src/valence/substrate/schema.sql
          psql -f src/valence/substrate/procedures.sql

      - name: Run database integration tests
        env:
          VKB_DB_HOST: localhost
          VKB_DB_PORT: 5432
          VKB_DB_NAME: valence_test
          VKB_DB_USER: valence
          VKB_DB_PASSWORD: testpass
        run: |
          pytest tests/integration/test_deployment.py \
                 tests/integration/test_belief_lifecycle.py \
                 tests/integration/test_trust_propagation.py \
                 -v --timeout=60 \
                 --cov=src/valence \
                 --cov-report=xml:coverage-integration-db.xml

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage-integration-db.xml
          flags: integration-db
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  integration-federation:
    name: Federation Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.test
          push: false
          load: true
          tags: valence-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start test environment
        run: |
          docker compose -f docker-compose.test.yml up -d postgres postgres-peer

          # Wait for databases
          echo "Waiting for databases..."
          sleep 10

          docker compose -f docker-compose.test.yml up -d valence-primary valence-peer

          # Wait for servers
          echo "Waiting for servers..."
          sleep 15

      - name: Check services health
        run: |
          echo "Checking primary server..."
          curl -f http://localhost:8080/api/v1/health || exit 1

          echo "Checking peer server..."
          curl -f http://localhost:8081/api/v1/health || exit 1

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Run federation tests
        env:
          VALENCE_PRIMARY_URL: http://localhost:8080
          VALENCE_PEER_URL: http://localhost:8081
          VKB_DB_HOST: localhost
          VKB_DB_PORT: 5433
          VKB_DB_NAME: valence_test
          VKB_DB_USER: valence
          VKB_DB_PASSWORD: testpass
          VKB_PEER_DB_PORT: 5434
        run: |
          ~/.local/bin/uv pip install -e ".[dev]" --system
          pytest tests/integration/test_federation_sync.py \
                 -v --timeout=120 \
                 --cov=src/valence \
                 --cov-report=xml:coverage-federation.xml

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage-federation.xml
          flags: integration-federation
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Primary Server Logs ==="
          docker compose -f docker-compose.test.yml logs valence-primary --tail=100
          echo "=== Peer Server Logs ==="
          docker compose -f docker-compose.test.yml logs valence-peer --tail=100
          echo "=== Primary DB Logs ==="
          docker compose -f docker-compose.test.yml logs postgres --tail=50

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

      # Optional: tmate debugging for troubleshooting
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled == 'true' && failure() }}
        with:
          limit-access-to-actor: true

  integration-api:
    name: API Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: integration-db

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: valence
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: valence_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: ~/.local/bin/uv pip install -e ".[dev]" --system

      - name: Initialize test database
        env:
          PGHOST: localhost
          PGUSER: valence
          PGPASSWORD: testpass
          PGDATABASE: valence_test
        run: |
          psql -f src/valence/substrate/schema.sql
          psql -f src/valence/substrate/procedures.sql

      - name: Start Valence server
        env:
          VKB_DB_HOST: localhost
          VKB_DB_PORT: 5432
          VKB_DB_NAME: valence_test
          VKB_DB_USER: valence
          VKB_DB_PASSWORD: testpass
          VALENCE_HOST: 0.0.0.0
          VALENCE_PORT: 8080
        run: |
          python -m valence.server.app &
          sleep 5
          curl -f http://localhost:8080/api/v1/health

      - name: Run API tests
        env:
          VALENCE_PRIMARY_URL: http://localhost:8080
          VKB_DB_HOST: localhost
          VKB_DB_PORT: 5432
          VKB_DB_NAME: valence_test
          VKB_DB_USER: valence
          VKB_DB_PASSWORD: testpass
        run: |
          pytest tests/server/ tests/integration/ \
                 -m "integration" \
                 -v --timeout=60 \
                 --ignore=tests/integration/test_federation_sync.py \
                 --cov=src/valence \
                 --cov-report=xml:coverage-api.xml

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage-api.xml
          flags: integration-api
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  nightly-report:
    name: Nightly Test Report
    runs-on: ubuntu-latest
    needs: [integration-db, integration-federation, integration-api]
    if: github.event_name == 'schedule'

    steps:
      - name: Generate summary
        run: |
          echo "# Nightly Integration Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Database Tests | ${{ needs.integration-db.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Federation Tests | ${{ needs.integration-federation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.integration-api.result }} |" >> $GITHUB_STEP_SUMMARY
