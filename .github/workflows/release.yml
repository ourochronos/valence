name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # full history for changelog

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: ~/.local/bin/uv pip install -e ".[dev]" --system

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in pyproject.toml
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git diff --cached --quiet || git commit -m "chore: bump version to $VERSION"

      - name: Run tests
        run: pytest tests/ -m "not integration and not slow" -v --tb=short

      - name: Build package
        run: ~/.local/bin/uv build

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="$PREVIOUS_TAG..HEAD"
          fi
          
          {
            echo "## What's Changed"
            echo ""
            
            # Conventional commit grouping
            FEAT=$(git log $RANGE --pretty=format:"%s" --no-merges | grep -E '^feat[:(]' || true)
            FIX=$(git log $RANGE --pretty=format:"%s" --no-merges | grep -E '^fix[:(]' || true)
            CHORE=$(git log $RANGE --pretty=format:"%s" --no-merges | grep -E '^chore[:(]' || true)
            DOCS=$(git log $RANGE --pretty=format:"%s" --no-merges | grep -E '^docs[:(]' || true)
            OTHER=$(git log $RANGE --pretty=format:"%s" --no-merges | grep -v -E '^(feat|fix|chore|docs)[:(]' || true)
            
            if [ -n "$FEAT" ]; then
              echo "### Features"
              echo "$FEAT" | sed 's/^/- /'
              echo ""
            fi
            
            if [ -n "$FIX" ]; then
              echo "### Bug Fixes"
              echo "$FIX" | sed 's/^/- /'
              echo ""
            fi
            
            if [ -n "$CHORE" ]; then
              echo "### Chores"
              echo "$CHORE" | sed 's/^/- /'
              echo ""
            fi
            
            if [ -n "$DOCS" ]; then
              echo "### Documentation"
              echo "$DOCS" | sed 's/^/- /'
              echo ""
            fi
            
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER" | sed 's/^/- /'
              echo ""
            fi
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.version.outputs.tag }}"
          } > CHANGELOG.md
          
          cat CHANGELOG.md

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
          files: dist/*
          draft: false
          prerelease: false
