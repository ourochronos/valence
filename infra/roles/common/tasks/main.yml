---
# Common role - base packages and configuration

- name: Install base packages
  apt:
    name:
      - git
      - curl
      - wget
      - htop
      - vim
      - tmux
      - build-essential
      - python3
      - python3-pip
      - python3-venv
      - nginx
      - certbot
      - python3-certbot-nginx
    state: present

- name: Set timezone
  timezone:
    name: UTC

- name: Create app directory
  file:
    path: /opt/valence
    state: directory
    owner: valence
    group: valence
    mode: '0755'

- name: Sync Valence code to server
  synchronize:
    src: "{{ playbook_dir }}/../"
    dest: /opt/valence/repo/
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=.venv"
      - "--exclude=venv"
      - "--exclude=*.sqlite"
      - "--exclude=*.db"
      - "--exclude=infra/.env.*"
  register: code_sync

- name: Set ownership of Valence repo
  file:
    path: /opt/valence/repo
    owner: valence
    group: valence
    recurse: yes

- name: Create Python venv
  command: python3 -m venv /opt/valence/venv
  args:
    creates: /opt/valence/venv
  become_user: valence

- name: Install Claude Code
  shell: |
    curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: /home/valence/.claude/bin/claude
    executable: /bin/bash
  become_user: valence

- name: Add Claude Code to PATH
  lineinfile:
    path: /home/valence/.bashrc
    line: 'export PATH="$HOME/.claude/bin:$PATH"'
    state: present
  become_user: valence
