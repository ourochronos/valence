---
# Synapse Matrix homeserver role

- name: Add Matrix repo key
  apt_key:
    url: https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
    state: present

- name: Add Matrix repo
  apt_repository:
    repo: "deb https://packages.matrix.org/debian/ {{ ansible_distribution_release }} main"
    state: present

- name: Install Synapse
  apt:
    name: matrix-synapse-py3
    state: present
    update_cache: yes

- name: Create Synapse config directory
  file:
    path: /etc/matrix-synapse/conf.d
    state: directory
    mode: '0755'

- name: Set server_name in conf.d (override Debian package default)
  copy:
    content: |
      # Server name configuration
      # Managed by Ansible
      server_name: "{{ synapse_server_name }}"
    dest: /etc/matrix-synapse/conf.d/server_name.yaml
    mode: '0644'
  notify: restart synapse

- name: Generate Synapse config
  template:
    src: homeserver.yaml.j2
    dest: /etc/matrix-synapse/homeserver.yaml
    mode: '0644'
  notify: restart synapse

- name: Configure Synapse to use PostgreSQL
  template:
    src: database.yaml.j2
    dest: /etc/matrix-synapse/conf.d/database.yaml
    mode: '0640'
    group: matrix-synapse
  notify: restart synapse

- name: Create Synapse signing key
  command: /opt/venvs/matrix-synapse/bin/python -m synapse.app.homeserver --config-path /etc/matrix-synapse/homeserver.yaml --generate-keys
  args:
    creates: /etc/matrix-synapse/{{ synapse_server_name }}.signing.key

- name: Configure nginx for Synapse (HTTP only for cert acquisition)
  template:
    src: nginx-synapse.conf.j2
    dest: /etc/nginx/sites-available/synapse
    mode: '0644'

- name: Enable nginx site
  file:
    src: /etc/nginx/sites-available/synapse
    dest: /etc/nginx/sites-enabled/synapse
    state: link

- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Reload nginx for HTTP config
  service:
    name: nginx
    state: reloaded

- name: Create webroot for certbot
  file:
    path: /var/www/html/.well-known/acme-challenge
    state: directory
    mode: '0755'

- name: Obtain SSL certificate
  command: >
    certbot certonly --webroot -w /var/www/html
    -d {{ domain }}
    --non-interactive --agree-tos --email {{ letsencrypt_email }}
  args:
    creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

- name: Configure nginx for Synapse (SSL enabled)
  template:
    src: nginx-synapse-ssl.conf.j2
    dest: /etc/nginx/sites-available/synapse
    mode: '0644'
  notify: reload nginx

- name: Flush handlers to apply SSL nginx config
  meta: flush_handlers

- name: Ensure Synapse is running
  service:
    name: matrix-synapse
    state: started
    enabled: yes

- name: Create admin user
  command: >
    register_new_matrix_user -c /etc/matrix-synapse/homeserver.yaml
    -u {{ synapse_admin_user }} -p "{{ lookup('env', 'SYNAPSE_ADMIN_PASSWORD') }}" -a
  args:
    creates: /opt/valence/.admin_user_created
  register: admin_created

- name: Mark admin user created
  file:
    path: /opt/valence/.admin_user_created
    state: touch
  when: admin_created.changed
