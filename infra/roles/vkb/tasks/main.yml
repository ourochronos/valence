---
# VKB (Valence Knowledge Base) service role

- name: Install VKB dependencies
  pip:
    name:
      - psycopg2-binary
      - mcp
      - openai
      - starlette
      - uvicorn[standard]
      - pydantic-settings
    virtualenv: /opt/valence/venv
  become_user: valence

- name: Install VKB package
  pip:
    name: /opt/valence/repo
    virtualenv: /opt/valence/venv
    editable: yes
  become_user: valence

- name: Create VKB config directory
  file:
    path: /opt/valence/config
    state: directory
    owner: valence
    group: valence
    mode: '0750'

- name: Create VKB environment file
  template:
    src: vkb.env.j2
    dest: /opt/valence/config/vkb.env
    owner: valence
    group: valence
    mode: '0600'

- name: Check if schema is already initialized
  stat:
    path: /opt/valence/.schema_initialized
  register: schema_marker

- name: Initialize VKB database schema
  shell: |
    source /opt/valence/venv/bin/activate
    cd /opt/valence/repo
    psql -h localhost -U {{ postgres_user }} -d {{ postgres_db }} -f src/valence/substrate/schema.sql
    psql -h localhost -U {{ postgres_user }} -d {{ postgres_db }} -f src/valence/substrate/procedures.sql
  environment:
    PGPASSWORD: "{{ postgres_password }}"
  become_user: valence
  when: not schema_marker.stat.exists
  register: schema_init

- name: Mark schema initialized
  file:
    path: /opt/valence/.schema_initialized
    state: touch
    owner: valence
    group: valence
    mode: '0644'
  when: schema_init.changed | default(false)

# Legacy stdio-based VKB service (kept for backwards compatibility)
- name: Create VKB systemd service
  template:
    src: vkb.service.j2
    dest: /etc/systemd/system/vkb.service
    mode: '0644'
  notify:
    - reload systemd
    - restart vkb

- name: Enable and start VKB service
  service:
    name: vkb
    state: started
    enabled: yes

# HTTP MCP Server
- name: Create token storage file with secure permissions
  file:
    path: /opt/valence/config/tokens.json
    state: touch
    owner: valence
    group: valence
    mode: '0600'
    modification_time: preserve
    access_time: preserve

- name: Initialize empty token store if not exists
  copy:
    content: '{"tokens": []}'
    dest: /opt/valence/config/tokens.json
    owner: valence
    group: valence
    mode: '0600'
    force: no

- name: Create Valence HTTP MCP server systemd service
  template:
    src: valence-server.service.j2
    dest: /etc/systemd/system/valence-server.service
    mode: '0644'
  notify:
    - reload systemd
    - restart valence-server

- name: Enable and start Valence HTTP MCP server
  service:
    name: valence-server
    state: started
    enabled: yes

# Nginx configuration
- name: Create nginx config directory for includes
  file:
    path: /etc/nginx/conf.d/valence
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create webroot for certbot
  file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Deploy base nginx site config
  template:
    src: nginx-valence-site.conf.j2
    dest: /etc/nginx/sites-available/valence
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload nginx

- name: Enable nginx site
  file:
    src: /etc/nginx/sites-available/valence
    dest: /etc/nginx/sites-enabled/valence
    state: link
  notify:
    - reload nginx

- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify:
    - reload nginx

- name: Obtain SSL certificate
  command: >
    certbot certonly --webroot -w /var/www/html
    -d {{ domain }}
    --email {{ letsencrypt_email }}
    --agree-tos --non-interactive
  args:
    creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

- name: Deploy Valence MCP nginx configuration
  template:
    src: nginx-valence.conf.j2
    dest: /etc/nginx/conf.d/valence/mcp.conf
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload nginx
