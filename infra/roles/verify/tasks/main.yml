---
# Verify role - post-deployment health checks
# This role runs after all other roles to verify the deployment
# NOTE: This role is skipped in check mode as it requires actual service state

- name: Skip verification in check mode
  meta: end_play
  when: ansible_check_mode

- name: Wait for services to stabilize
  pause:
    seconds: 5
  when: verify_wait | default(true)

# === Service Status Checks ===
- name: Check PostgreSQL service
  service_facts:
  register: service_facts

- name: Verify PostgreSQL is running
  assert:
    that:
      - "'postgresql.service' in ansible_facts.services"
      - "ansible_facts.services['postgresql.service'].state == 'running'"
    fail_msg: "PostgreSQL service is not running"
    success_msg: "PostgreSQL service is running"

- name: Verify nginx is running
  assert:
    that:
      - "'nginx.service' in ansible_facts.services"
      - "ansible_facts.services['nginx.service'].state == 'running'"
    fail_msg: "nginx service is not running"
    success_msg: "nginx service is running"

- name: Verify Valence HTTP MCP server is running
  assert:
    that:
      - "'valence-server.service' in ansible_facts.services"
      - "ansible_facts.services['valence-server.service'].state == 'running'"
    fail_msg: "Valence HTTP MCP server is not running"
    success_msg: "Valence HTTP MCP server is running"

# === Database Connectivity ===
- name: Test PostgreSQL connectivity
  become_user: postgres
  shell: psql -c "SELECT 1 AS test" -t
  register: pg_test
  changed_when: false

- name: Verify PostgreSQL connection
  assert:
    that:
      - pg_test.rc == 0
      - "'1' in pg_test.stdout"
    fail_msg: "PostgreSQL is not accepting connections"
    success_msg: "PostgreSQL is accepting connections"

- name: Check valence database exists
  become_user: postgres
  shell: psql -lqt | cut -d \| -f 1 | grep -qw valence
  register: db_exists
  changed_when: false
  failed_when: false

- name: Verify valence database
  assert:
    that:
      - db_exists.rc == 0
    fail_msg: "Valence database does not exist"
    success_msg: "Valence database exists"

- name: Check pgvector extension
  become_user: postgres
  shell: psql -d valence -t -c "SELECT 1 FROM pg_extension WHERE extname='vector'"
  register: pgvector_check
  changed_when: false

- name: Verify pgvector extension
  assert:
    that:
      - "'1' in pgvector_check.stdout"
    fail_msg: "pgvector extension is not installed"
    success_msg: "pgvector extension is installed"

- name: Count schema tables
  become_user: postgres
  shell: psql -d valence -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema='public'"
  register: table_count
  changed_when: false

- name: Verify schema has tables
  assert:
    that:
      - table_count.stdout | int > 0
    fail_msg: "Schema appears empty"
    success_msg: "Schema has {{ table_count.stdout | trim }} tables"

# === HTTP Endpoint Checks ===
- name: Check Valence health endpoint
  uri:
    url: "https://{{ domain }}/health"
    return_content: yes
    status_code: 200
    validate_certs: yes
  register: health_check
  retries: 3
  delay: 5
  until: health_check is succeeded
  failed_when: false

- name: Verify Valence health endpoint
  assert:
    that:
      - health_check.status == 200
      - "'healthy' in health_check.content"
    fail_msg: "Valence health endpoint not accessible"
    success_msg: "Valence health endpoint is accessible"
  when: health_check is defined

- name: Check Valence info endpoint
  uri:
    url: "https://{{ domain }}/"
    return_content: yes
    status_code: 200
    validate_certs: yes
  register: info_check
  retries: 3
  delay: 5
  until: info_check is succeeded
  failed_when: false

- name: Verify Valence info endpoint
  assert:
    that:
      - info_check.status == 200
      - "'tools' in info_check.content"
    fail_msg: "Valence info endpoint not responding correctly"
    success_msg: "Valence info endpoint is responding"
  when: info_check is defined

# === Log Error Check ===
- name: Check valence-server logs for recent errors
  shell: journalctl -u valence-server --since "10 minutes ago" --no-pager 2>/dev/null | grep -ci error || echo 0
  register: server_errors
  changed_when: false
  failed_when: false

- name: Warn about valence-server errors
  debug:
    msg: "WARNING: Found {{ server_errors.stdout }} error(s) in recent valence-server logs"
  when: server_errors.stdout | int > 0

# === Resource Checks ===
- name: Check disk space
  shell: df -h / | tail -1 | awk '{print $5}' | tr -d '%'
  register: disk_usage
  changed_when: false

- name: Warn if disk usage high
  debug:
    msg: "WARNING: Disk usage at {{ disk_usage.stdout }}%"
  when: disk_usage.stdout | int > 80

- name: Check available memory
  shell: free -m | awk '/Mem:/ {print $7}'
  register: mem_free
  changed_when: false

- name: Warn if memory low
  debug:
    msg: "WARNING: Available memory only {{ mem_free.stdout }}MB"
  when: mem_free.stdout | int < 500

# === Summary ===
- name: Deployment verification complete
  debug:
    msg: |
      Deployment verification completed successfully!

      Services:
        - PostgreSQL: running
        - nginx: running
        - Valence MCP Server: running

      Database:
        - Valence DB: exists
        - pgvector: installed
        - Tables: {{ table_count.stdout | trim }}

      Endpoints:
        - https://{{ domain }}/health: accessible
        - https://{{ domain }}/: responding

      Resources:
        - Disk: {{ disk_usage.stdout }}% used
        - Memory: {{ mem_free.stdout }}MB available
