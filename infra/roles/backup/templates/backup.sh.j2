#!/bin/bash
# Valence backup script
# Backs up database, config, and browser sessions to DigitalOcean Spaces
# Generated by Ansible - do not edit manually

set -e

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/tmp/valence-backup-$TIMESTAMP"
S3_CONFIG="/opt/valence/config/.s3cfg"
S3_BUCKET="s3://{{ do_spaces_bucket }}"

echo "=== Starting Valence backup: $TIMESTAMP ==="

# Check if s3cmd config exists
if [ ! -f "$S3_CONFIG" ]; then
    echo "ERROR: s3cmd config not found at $S3_CONFIG"
    echo "Backup will be stored locally only"
    S3_ENABLED=false
else
    S3_ENABLED=true
fi

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Database backup
echo "Backing up database..."
PGPASSWORD="{{ postgres_password }}" pg_dump \
    -h localhost \
    -U {{ postgres_user }} \
    {{ postgres_db }} \
    | gzip > "$BACKUP_DIR/database.sql.gz"
echo "Database backup complete: $(du -h "$BACKUP_DIR/database.sql.gz" | cut -f1)"

# Config backup (tokens, oauth clients, etc.)
echo "Backing up configuration..."
if [ -d /opt/valence/config ]; then
    # Exclude .s3cfg from backup (contains credentials)
    tar --exclude='.s3cfg' -czf "$BACKUP_DIR/config.tar.gz" -C /opt/valence config
    echo "Config backup complete: $(du -h "$BACKUP_DIR/config.tar.gz" | cut -f1)"
else
    echo "No config directory found, skipping"
fi

# Create manifest
cat > "$BACKUP_DIR/manifest.json" << EOF
{
    "timestamp": "$TIMESTAMP",
    "hostname": "$(hostname)",
    "valence_version": "$(cat /opt/valence/version 2>/dev/null || echo 'unknown')",
    "files": {
        "database": "database.sql.gz",
        "config": "config.tar.gz"
    }
}
EOF

# Upload to DO Spaces
if [ "$S3_ENABLED" = true ]; then
    echo "Uploading to DigitalOcean Spaces..."
    s3cmd -c "$S3_CONFIG" put "$BACKUP_DIR"/* "$S3_BUCKET/backups/$TIMESTAMP/"
    echo "Upload complete"

    # Keep only last 30 backups
    echo "Cleaning up old backups..."
    s3cmd -c "$S3_CONFIG" ls "$S3_BUCKET/backups/" | \
        sort -r | \
        tail -n +31 | \
        awk '{print $4}' | \
        while read -r backup_path; do
            if [ -n "$backup_path" ]; then
                echo "Removing old backup: $backup_path"
                s3cmd -c "$S3_CONFIG" del --recursive "$backup_path"
            fi
        done
fi

# Keep local backup for 24 hours
LOCAL_BACKUP="/opt/valence/backups/$TIMESTAMP"
mkdir -p "$LOCAL_BACKUP"
mv "$BACKUP_DIR"/* "$LOCAL_BACKUP/"
rmdir "$BACKUP_DIR"

# Clean up local backups older than 24 hours
find /opt/valence/backups -maxdepth 1 -type d -mtime +1 -exec rm -rf {} \; 2>/dev/null || true

echo "=== Backup completed: $TIMESTAMP ==="
echo "Local backup: $LOCAL_BACKUP"
if [ "$S3_ENABLED" = true ]; then
    echo "Remote backup: $S3_BUCKET/backups/$TIMESTAMP/"
fi
