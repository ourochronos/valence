#!/bin/bash
# Valence restore script
# Restores from DigitalOcean Spaces backup
# Generated by Ansible - do not edit manually

set -e

S3_CONFIG="/opt/valence/config/.s3cfg"
S3_BUCKET="s3://{{ do_spaces_bucket }}"

usage() {
    echo "Usage: $0 [TIMESTAMP]"
    echo ""
    echo "Restore Valence from a backup."
    echo ""
    echo "Arguments:"
    echo "  TIMESTAMP   Backup timestamp (e.g., 20250101_030000)"
    echo "              If not specified, lists available backups"
    echo ""
    echo "Examples:"
    echo "  $0                    # List available backups"
    echo "  $0 20250101_030000    # Restore specific backup"
}

list_backups() {
    echo "Available backups:"
    echo ""
    if [ -f "$S3_CONFIG" ]; then
        s3cmd -c "$S3_CONFIG" ls "$S3_BUCKET/backups/" | awk '{print $2}' | sed 's|.*/||' | sort -r
    else
        echo "ERROR: s3cmd config not found. Cannot list remote backups."
        echo ""
        echo "Local backups:"
        ls -1 /opt/valence/backups/ 2>/dev/null || echo "  (none)"
    fi
}

restore_backup() {
    local TIMESTAMP="$1"
    local RESTORE_DIR="/tmp/valence-restore-$$"

    echo "=== Starting restore from backup: $TIMESTAMP ==="

    # Create restore directory
    mkdir -p "$RESTORE_DIR"

    # Download from S3 or use local
    if [ -d "/opt/valence/backups/$TIMESTAMP" ]; then
        echo "Using local backup..."
        cp -r "/opt/valence/backups/$TIMESTAMP"/* "$RESTORE_DIR/"
    elif [ -f "$S3_CONFIG" ]; then
        echo "Downloading from DigitalOcean Spaces..."
        s3cmd -c "$S3_CONFIG" get --recursive "$S3_BUCKET/backups/$TIMESTAMP/" "$RESTORE_DIR/"
    else
        echo "ERROR: Backup not found locally and s3cmd not configured"
        exit 1
    fi

    # Verify manifest
    if [ ! -f "$RESTORE_DIR/manifest.json" ]; then
        echo "ERROR: Invalid backup - manifest.json not found"
        rm -rf "$RESTORE_DIR"
        exit 1
    fi

    echo "Backup manifest:"
    cat "$RESTORE_DIR/manifest.json"
    echo ""

    # Confirm restore
    read -p "This will overwrite current data. Continue? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Restore cancelled"
        rm -rf "$RESTORE_DIR"
        exit 0
    fi

    # Stop services
    echo "Stopping services..."
    sudo systemctl stop valence-server 2>/dev/null || true

    # Restore database
    if [ -f "$RESTORE_DIR/database.sql.gz" ]; then
        echo "Restoring database..."
        gunzip -c "$RESTORE_DIR/database.sql.gz" | \
            PGPASSWORD="{{ postgres_password }}" psql \
                -h localhost \
                -U {{ postgres_user }} \
                {{ postgres_db }}
        echo "Database restored"
    fi

    # Restore config
    if [ -f "$RESTORE_DIR/config.tar.gz" ]; then
        echo "Restoring configuration..."
        # Backup current config first
        if [ -d /opt/valence/config ]; then
            mv /opt/valence/config /opt/valence/config.pre-restore
        fi
        tar -xzf "$RESTORE_DIR/config.tar.gz" -C /opt/valence
        echo "Config restored"
    fi

    # Clean up
    rm -rf "$RESTORE_DIR"

    # Restart services
    echo "Starting services..."
    sudo systemctl start valence-server 2>/dev/null || true

    echo "=== Restore completed ==="
}

# Main
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    usage
    exit 0
elif [ -z "$1" ]; then
    list_backups
else
    restore_backup "$1"
fi
