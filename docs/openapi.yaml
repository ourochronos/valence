openapi: 3.0.3
info:
  title: Valence API
  description: |
    The trust layer for AI agents. Valence provides infrastructure for how beliefs travel between minds.

    ## Overview

    Valence is a personal knowledge substrate that stores beliefs with confidence scores,
    tracks conversations, and enables federation between nodes.

    ## Authentication

    The API supports two authentication methods:

    ### Bearer Token (Legacy)
    ```
    Authorization: Bearer <token>
    ```

    ### OAuth 2.1 with PKCE
    1. Register client via `/api/v1/oauth/register`
    2. Start authorization flow at `/api/v1/oauth/authorize`
    3. Exchange code for token at `/api/v1/oauth/token`

    ## Error Handling

    All endpoints return errors in a consistent format:
    ```json
    {
      "error": "error_code",
      "error_description": "Human-readable description"
    }
    ```

    MCP endpoints use JSON-RPC 2.0 error codes.

  version: 1.0.0
  contact:
    name: Valence
    url: https://github.com/ourochronos/valence
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8420
    description: Local development server
  - url: '{baseUrl}'
    description: Custom server
    variables:
      baseUrl:
        default: http://localhost:8420
        description: Base URL of the Valence server

tags:
  - name: Discovery
    description: Server information and discovery endpoints
  - name: Health
    description: Health check endpoints
  - name: MCP
    description: Model Context Protocol (JSON-RPC over HTTP)
  - name: OAuth
    description: OAuth 2.1 authentication endpoints
  - name: Federation
    description: Federation protocol and node management
  - name: Beliefs
    description: Belief management and corroboration
  - name: Substrate
    description: |
      Knowledge substrate REST API. Provides direct access to beliefs, entities,
      tensions, confidence, and trust without JSON-RPC.
      Requires `substrate:read` or `substrate:write` scope.
  - name: Entities
    description: Entity management (people, tools, concepts)
  - name: Tensions
    description: Contradictions between beliefs
  - name: Trust
    description: Trust level checks for entities and topics
  - name: Sessions
    description: Conversation session management
  - name: Exchanges
    description: Conversation turn tracking within sessions
  - name: Patterns
    description: Behavioral pattern tracking across sessions
  - name: Insights
    description: Extract insights from sessions into the knowledge base
  - name: Compliance
    description: GDPR and compliance endpoints

paths:
  /:
    get:
      tags:
        - Discovery
      summary: Server information
      description: Returns basic server information and available endpoints. No authentication required.
      operationId: getServerInfo
      responses:
        '200':
          description: Server information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerInfo'
              example:
                server: valence-mcp-server
                version: 0.1.0
                apiVersion: v1
                protocol: mcp
                protocolVersion: "2024-11-05"
                transport: http
                tools:
                  substrate: 12
                  vkb: 10
                  total: 22
                endpoints:
                  mcp: /api/v1/mcp
                  health: /api/v1/health
                  info: /
                  federation: /api/v1/federation/status
                  beliefs: /api/v1/beliefs
                authentication:
                  methods:
                    - bearer
                    - oauth2

  /api/v1/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns server health status including database connectivity.
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                server: valence-mcp-server
                version: 0.1.0
                database: connected
        '503':
          description: Server is degraded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: degraded
                server: valence-mcp-server
                version: 0.1.0
                database: "error: connection refused"

  /api/v1/mcp:
    post:
      tags:
        - MCP
      summary: MCP JSON-RPC endpoint
      description: |
        Main endpoint for Model Context Protocol (MCP) operations.
        Accepts JSON-RPC 2.0 requests for tool calls, resource reads, and prompts.

        ## Supported Methods

        - `initialize` - Initialize the MCP session
        - `initialized` - Acknowledge initialization
        - `ping` - Health check
        - `tools/list` - List available tools
        - `tools/call` - Call a tool
        - `resources/list` - List available resources
        - `resources/read` - Read a resource
        - `prompts/list` - List available prompts
        - `prompts/get` - Get a prompt

      operationId: mcpEndpoint
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools, mcp:resources, mcp:prompts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JsonRpcRequest'
            examples:
              initialize:
                summary: Initialize session
                value:
                  jsonrpc: "2.0"
                  method: initialize
                  params:
                    protocolVersion: "2024-11-05"
                    capabilities: {}
                    clientInfo:
                      name: my-client
                      version: "1.0.0"
                  id: 1
              listTools:
                summary: List available tools
                value:
                  jsonrpc: "2.0"
                  method: tools/list
                  id: 2
              callTool:
                summary: Call a tool
                value:
                  jsonrpc: "2.0"
                  method: tools/call
                  params:
                    name: belief_query
                    arguments:
                      query: "database scaling"
                  id: 3
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcResponse'
        '204':
          description: Notification acknowledged (no response body)
        '400':
          description: Parse error or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'
              example:
                jsonrpc: "2.0"
                error:
                  code: -32700
                  message: "Parse error: invalid JSON"
                id: null
        '401':
          description: Unauthorized
          headers:
            WWW-Authenticate:
              schema:
                type: string
              description: Authentication challenge
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'
              example:
                jsonrpc: "2.0"
                error:
                  code: -32001
                  message: "Unauthorized: Invalid or missing authentication token"
                id: null
        '429':
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'
              example:
                jsonrpc: "2.0"
                error:
                  code: -32002
                  message: "Rate limited: Too many requests"
                id: null
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'

  # OAuth Endpoints
  /.well-known/oauth-protected-resource:
    get:
      tags:
        - OAuth
      summary: Protected resource metadata
      description: |
        RFC 9728 Protected Resource Metadata.
        Returns information about the protected resource and its authorization servers.
      operationId: protectedResourceMetadata
      responses:
        '200':
          description: Protected resource metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProtectedResourceMetadata'
              example:
                resource: http://localhost:8420/api/v1/mcp
                authorization_servers:
                  - http://localhost:8420
                scopes_supported:
                  - mcp:tools
                  - mcp:resources
                  - mcp:prompts
                bearer_methods_supported:
                  - header
                resource_documentation: http://localhost:8420/docs

  /.well-known/oauth-authorization-server:
    get:
      tags:
        - OAuth
      summary: Authorization server metadata
      description: |
        RFC 8414 Authorization Server Metadata.
        Returns OAuth 2.1 server configuration.
      operationId: authorizationServerMetadata
      responses:
        '200':
          description: Authorization server metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizationServerMetadata'

  /api/v1/oauth/register:
    post:
      tags:
        - OAuth
      summary: Dynamic client registration
      description: |
        RFC 7591 Dynamic Client Registration.
        Allows clients to register themselves for OAuth authentication.
      operationId: registerClient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRegistrationRequest'
            example:
              redirect_uris:
                - http://localhost:3000/callback
              client_name: My MCP Client
              grant_types:
                - authorization_code
                - refresh_token
              scope: mcp:tools mcp:resources
      responses:
        '201':
          description: Client registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRegistrationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /api/v1/oauth/authorize:
    get:
      tags:
        - OAuth
      summary: Authorization endpoint (display login)
      description: |
        OAuth 2.1 Authorization Endpoint.
        Displays login form for user authentication.
      operationId: authorizeGet
      parameters:
        - name: response_type
          in: query
          required: true
          schema:
            type: string
            enum: [code]
        - name: client_id
          in: query
          required: true
          schema:
            type: string
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
            format: uri
        - name: scope
          in: query
          schema:
            type: string
            default: mcp:tools
        - name: state
          in: query
          schema:
            type: string
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
          description: PKCE code challenge (S256)
        - name: code_challenge_method
          in: query
          schema:
            type: string
            enum: [S256]
            default: S256
      responses:
        '200':
          description: Login form HTML
          content:
            text/html:
              schema:
                type: string
        '302':
          description: Redirect with error
        '400':
          description: Invalid request
          content:
            text/html:
              schema:
                type: string
    post:
      tags:
        - OAuth
      summary: Authorization endpoint (submit login)
      description: Process login form submission
      operationId: authorizePost
      parameters:
        - name: response_type
          in: query
          required: true
          schema:
            type: string
        - name: client_id
          in: query
          required: true
          schema:
            type: string
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
        - name: code_challenge_method
          in: query
          schema:
            type: string
        - name: scope
          in: query
          schema:
            type: string
        - name: state
          in: query
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                password:
                  type: string
                  format: password
      responses:
        '302':
          description: Redirect to client with authorization code
        '200':
          description: Login form with error
          content:
            text/html:
              schema:
                type: string

  /api/v1/oauth/token:
    post:
      tags:
        - OAuth
      summary: Token endpoint
      description: |
        OAuth 2.1 Token Endpoint.
        Exchanges authorization code for tokens or refreshes access tokens.
      operationId: token
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AuthorizationCodeGrant'
                - $ref: '#/components/schemas/RefreshTokenGrant'
      responses:
        '200':
          description: Token response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  # Federation Discovery Endpoints
  /.well-known/vfp-node-metadata:
    get:
      tags:
        - Federation
      summary: VFP node metadata (DID document)
      description: |
        Returns the node's DID document for federation discovery.
        This is the primary discovery endpoint for the Valence Federation Protocol.
      operationId: vfpNodeMetadata
      responses:
        '200':
          description: DID document
          headers:
            Content-Type:
              schema:
                type: string
                example: application/did+ld+json
            Cache-Control:
              schema:
                type: string
                example: max-age=3600
          content:
            application/did+ld+json:
              schema:
                $ref: '#/components/schemas/DIDDocument'
        '404':
          description: Federation not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /.well-known/vfp-trust-anchors:
    get:
      tags:
        - Federation
      summary: Trust anchors
      description: |
        Returns the node's trust anchors (nodes explicitly trusted).
        Only available if the node publishes its trust anchors.
      operationId: vfpTrustAnchors
      responses:
        '200':
          description: Trust anchors list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustAnchorsResponse'
        '404':
          description: Federation not enabled or trust anchors not published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/federation/status:
    get:
      tags:
        - Federation
      summary: Federation status
      description: Get federation status for this node
      operationId: federationStatus
      responses:
        '200':
          description: Federation status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FederationStatus'
        '404':
          description: Federation not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Belief Corroboration Endpoints
  /api/v1/beliefs/{belief_id}/corroboration:
    get:
      tags:
        - Beliefs
      summary: Get belief corroboration
      description: |
        Returns corroboration details for a belief, including
        how many independent sources have corroborated it.
      operationId: getBeliefCorroboration
      parameters:
        - name: belief_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the belief
      responses:
        '200':
          description: Corroboration details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorroborationResponse'
              example:
                success: true
                belief_id: "550e8400-e29b-41d4-a716-446655440000"
                corroboration_count: 3
                confidence_corroboration: 0.47
                corroborating_sources:
                  - source_did: "did:vkb:web:example.com"
                    similarity: 0.95
                    corroborated_at: "2025-02-03T12:00:00Z"
                confidence_label: "moderately corroborated"
        '400':
          description: Invalid belief ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Belief not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/beliefs/most-corroborated:
    get:
      tags:
        - Beliefs
      summary: Get most corroborated beliefs
      description: Returns beliefs with the highest corroboration counts
      operationId: getMostCorroboratedBeliefs
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Maximum number of results
        - name: min_count
          in: query
          schema:
            type: integer
            default: 1
            minimum: 0
          description: Minimum corroboration count
        - name: domain
          in: query
          schema:
            type: string
          description: Filter by domain
      responses:
        '200':
          description: List of corroborated beliefs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MostCorroboratedResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Substrate REST Endpoints (Issue #381)
  /api/v1/beliefs:
    get:
      tags:
        - Substrate
      summary: Search beliefs
      description: Search beliefs by keyword with optional domain, entity, and archive filters.
      operationId: listBeliefs
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Search query string
        - name: domain_filter
          in: query
          schema:
            type: string
          description: Comma-separated domain path filter (e.g., "tech,python")
        - name: entity_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by related entity UUID
        - name: include_superseded
          in: query
          schema:
            type: boolean
            default: false
          description: Include superseded beliefs
        - name: include_revoked
          in: query
          schema:
            type: boolean
            default: false
          description: Include beliefs with revoked consent chains
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived beliefs
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Maximum number of results
        - name: ranking
          in: query
          schema:
            type: string
          description: JSON-encoded ranking configuration (e.g., {"semantic_weight":0.5,"confidence_weight":0.35,"recency_weight":0.15})
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeliefListResponse'
        '400':
          description: Missing query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      tags:
        - Substrate
      summary: Create a belief
      description: Create a new belief with optional confidence, domain classification, and entity links.
      operationId: createBelief
      security:
        - bearerAuth: []
        - oauth2: [substrate:write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBeliefRequest'
            example:
              content: "Python is excellent for rapid prototyping"
              domain_path: ["tech", "python"]
              confidence:
                overall: 0.85
              entities:
                - name: Python
                  type: tool
                  role: subject
      responses:
        '201':
          description: Belief created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeliefResponse'
        '400':
          description: Missing required field or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/beliefs/search:
    get:
      tags:
        - Substrate
      summary: Semantic search beliefs
      description: Search beliefs using vector embeddings for semantic similarity. Requires embeddings to be enabled.
      operationId: searchBeliefs
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Natural language search query
        - name: min_similarity
          in: query
          schema:
            type: number
            default: 0.5
            minimum: 0
            maximum: 1
          description: Minimum similarity threshold
        - name: min_confidence
          in: query
          schema:
            type: number
            minimum: 0
            maximum: 1
          description: Filter by minimum overall confidence
        - name: domain_filter
          in: query
          schema:
            type: string
          description: Comma-separated domain path filter
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
        - name: ranking
          in: query
          schema:
            type: string
          description: JSON-encoded ranking configuration
      responses:
        '200':
          description: Semantic search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeliefSearchResponse'
        '400':
          description: Missing query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/beliefs/{belief_id}:
    get:
      tags:
        - Substrate
      summary: Get belief by ID
      description: Retrieve a specific belief with optional history and tension details.
      operationId: getBelief
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: belief_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the belief
        - name: include_history
          in: query
          schema:
            type: boolean
            default: false
          description: Include supersession chain history
        - name: include_tensions
          in: query
          schema:
            type: boolean
            default: false
          description: Include related tensions
      responses:
        '200':
          description: Belief details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeliefResponse'
        '404':
          description: Belief not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/beliefs/{belief_id}/supersede:
    post:
      tags:
        - Substrate
      summary: Supersede a belief
      description: Replace an existing belief with updated content, maintaining the history chain.
      operationId: supersedeBelief
      security:
        - bearerAuth: []
        - oauth2: [substrate:write]
      parameters:
        - name: belief_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the belief to supersede
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupersedeBeliefRequest'
            example:
              new_content: "Python 3.12+ is excellent for rapid prototyping"
              reason: "Updated to specify version requirement"
      responses:
        '200':
          description: Belief superseded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeliefResponse'
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '404':
          description: Original belief not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/beliefs/{belief_id}/confidence:
    get:
      tags:
        - Substrate
      summary: Explain confidence score
      description: Get a detailed breakdown of a belief's confidence score across all dimensions.
      operationId: explainConfidence
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: belief_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the belief
      responses:
        '200':
          description: Confidence breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfidenceExplainResponse'
        '404':
          description: Belief not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/entities:
    get:
      tags:
        - Entities
      summary: Search entities
      description: Search entities by name with optional type filter.
      operationId: searchEntities
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Search query (matches name and aliases)
        - name: type
          in: query
          schema:
            type: string
            enum: [person, organization, tool, concept, project, location, service]
          description: Filter by entity type
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Entity search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityListResponse'
        '400':
          description: Missing query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/entities/{id}:
    get:
      tags:
        - Entities
      summary: Get entity by ID
      description: Retrieve a specific entity with optional related beliefs.
      operationId: getEntity
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the entity
        - name: include_beliefs
          in: query
          schema:
            type: boolean
            default: false
          description: Include related beliefs
        - name: belief_limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Maximum number of related beliefs to return
      responses:
        '200':
          description: Entity details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityResponse'
        '404':
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/tensions:
    get:
      tags:
        - Tensions
      summary: List tensions
      description: List contradictions between beliefs with optional filters.
      operationId: listTensions
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [detected, investigating, resolved, accepted]
          description: Filter by tension status
        - name: severity
          in: query
          schema:
            type: string
            enum: [low, medium, high, critical]
          description: Filter by minimum severity
        - name: entity_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by related entity
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of tensions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TensionListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/tensions/{id}/resolve:
    post:
      tags:
        - Tensions
      summary: Resolve a tension
      description: Mark a tension as resolved with an explanation and action.
      operationId: resolveTension
      security:
        - bearerAuth: []
        - oauth2: [substrate:write]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tension
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveTensionRequest'
            example:
              resolution: "Belief A is more recent and accurate"
              action: supersede_b
      responses:
        '200':
          description: Tension resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '404':
          description: Tension not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/trust:
    get:
      tags:
        - Trust
      summary: Check trust levels
      description: Check trust levels for entities or federation nodes on a specific topic.
      operationId: checkTrust
      security:
        - bearerAuth: []
        - oauth2: [substrate:read]
      parameters:
        - name: topic
          in: query
          required: true
          schema:
            type: string
          description: Topic or domain to check trust for
        - name: entity_name
          in: query
          schema:
            type: string
          description: Specific entity to check trust for
        - name: include_federated
          in: query
          schema:
            type: boolean
            default: true
          description: Include federated node trust
        - name: min_trust
          in: query
          schema:
            type: number
            default: 0.3
            minimum: 0
            maximum: 1
          description: Minimum trust threshold
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
        - name: domain
          in: query
          schema:
            type: string
          description: Domain context for trust check
      responses:
        '200':
          description: Trust check results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustCheckResponse'
        '400':
          description: Missing topic parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # VKB REST Endpoints (Issue #380)
  /api/v1/sessions:
    post:
      tags:
        - Sessions
      summary: Start a new session
      description: Start a new conversation tracking session.
      operationId: createSession
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
            example:
              platform: openclaw
              external_room_id: "room-42"
              project_context: "valence-integration"
      responses:
        '201':
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '400':
          description: Missing platform field
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    get:
      tags:
        - Sessions
      summary: List sessions
      description: List sessions with optional filters for platform, project, and status.
      operationId: listSessions
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: platform
          in: query
          schema:
            type: string
            enum: [claude-code, api, slack, claude-web, claude-desktop, claude-mobile, openclaw]
          description: Filter by platform
        - name: project_context
          in: query
          schema:
            type: string
          description: Filter by project context
        - name: status
          in: query
          schema:
            type: string
            enum: [active, completed, abandoned]
          description: Filter by session status
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/sessions/by-room/{room_id}:
    get:
      tags:
        - Sessions
      summary: Find session by room ID
      description: Find an active session by its external room/channel ID.
      operationId: findSessionByRoom
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: room_id
          in: path
          required: true
          schema:
            type: string
          description: External room or channel ID
      responses:
        '200':
          description: Active session found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: No active session found for this room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/sessions/{id}:
    get:
      tags:
        - Sessions
      summary: Get session by ID
      description: Get session details with optional exchange history.
      operationId: getSession
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
        - name: include_exchanges
          in: query
          schema:
            type: boolean
            default: false
          description: Include recent exchanges
        - name: exchange_limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Maximum exchanges to include
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/sessions/{id}/end:
    post:
      tags:
        - Sessions
      summary: End a session
      description: Close a session with optional summary and themes.
      operationId: endSession
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EndSessionRequest'
            example:
              summary: "Discussed REST API design for Valence"
              themes: ["api-design", "rest", "openapi"]
              status: completed
      responses:
        '200':
          description: Session ended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/sessions/{id}/exchanges:
    post:
      tags:
        - Exchanges
      summary: Add an exchange
      description: Record a conversation turn (exchange) in a session.
      operationId: addExchange
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddExchangeRequest'
            example:
              role: user
              content: "How do I configure the REST API?"
              tokens_approx: 42
      responses:
        '201':
          description: Exchange added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeResponse'
        '400':
          description: Missing required fields (role, content)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    get:
      tags:
        - Exchanges
      summary: List exchanges
      description: List exchanges (conversation turns) for a session with pagination.
      operationId: listExchanges
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
          description: Maximum exchanges to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of exchanges to skip
      responses:
        '200':
          description: List of exchanges
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/sessions/{id}/insights:
    post:
      tags:
        - Insights
      summary: Extract an insight
      description: |
        Extract an insight from a session and create a belief in the knowledge base.
        Performs content-hash deduplication to avoid storing duplicate insights.
      operationId: extractInsight
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExtractInsightRequest'
            example:
              content: "User prefers TDD workflow for Python projects"
              domain_path: ["tech", "python", "testing"]
              confidence:
                overall: 0.85
      responses:
        '201':
          description: Insight extracted and belief created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InsightResponse'
        '400':
          description: Missing content field
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    get:
      tags:
        - Insights
      summary: List insights
      description: List all insights extracted from a session.
      operationId: listInsights
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      responses:
        '200':
          description: List of insights
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InsightListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/patterns:
    post:
      tags:
        - Patterns
      summary: Record a pattern
      description: Record a new behavioral pattern with optional evidence sessions.
      operationId: createPattern
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePatternRequest'
            example:
              type: preference
              description: "Prefers dark mode in all editors"
              evidence: ["sess-1", "sess-2"]
              confidence: 0.7
      responses:
        '201':
          description: Pattern recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatternResponse'
        '400':
          description: Missing required fields (type, description)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    get:
      tags:
        - Patterns
      summary: List patterns
      description: List behavioral patterns with optional type, status, and confidence filters.
      operationId: listPatterns
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: type
          in: query
          schema:
            type: string
          description: Filter by pattern type (e.g., preference, working_style, topic_recurrence)
        - name: status
          in: query
          schema:
            type: string
            enum: [emerging, established, fading, archived]
          description: Filter by pattern status
        - name: min_confidence
          in: query
          schema:
            type: number
            default: 0
            minimum: 0
            maximum: 1
          description: Minimum confidence threshold
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of patterns
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatternListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/patterns/search:
    get:
      tags:
        - Patterns
      summary: Search patterns
      description: Search patterns by description using text matching.
      operationId: searchPatterns
      security:
        - bearerAuth: []
        - oauth2: [vkb:read]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Pattern search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatternListResponse'
        '400':
          description: Missing query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/patterns/{id}/reinforce:
    post:
      tags:
        - Patterns
      summary: Reinforce a pattern
      description: Strengthen an existing pattern with new evidence. Increases confidence and may update status.
      operationId: reinforcePattern
      security:
        - bearerAuth: []
        - oauth2: [vkb:write]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Pattern UUID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReinforcePatternRequest'
            example:
              session_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Pattern reinforced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Pattern not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # Compliance Endpoints
  /api/v1/users/{id}/data:
    delete:
      tags:
        - Compliance
      summary: Delete user data (GDPR Article 17)
      description: |
        Implements GDPR Article 17 "Right to Erasure".
        Performs cryptographic erasure of all user data:
        - Creates tombstone records for federation propagation
        - Performs key revocation (cryptographic erasure)
        - Maintains audit trail
      operationId: deleteUserData
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: User identifier
        - name: reason
          in: query
          schema:
            type: string
            enum:
              - user_request
              - consent_withdrawn
              - purpose_fulfilled
              - unlawful_processing
              - legal_obligation
              - objection
            default: user_request
          description: Deletion reason for audit
        - name: legal_basis
          in: query
          schema:
            type: string
          description: Additional legal basis description
      responses:
        '200':
          description: Deletion successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Deletion failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/tombstones/{id}/verification:
    get:
      tags:
        - Compliance
      summary: Get deletion verification
      description: |
        Returns a verification report for compliance auditing.
        Use this to verify that data deletion was completed correctly.
      operationId: getDeletionVerification
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tombstone UUID
      responses:
        '200':
          description: Verification report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationReport'
        '400':
          description: Invalid tombstone ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tombstone not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/openapi.json:
    get:
      tags:
        - Discovery
      summary: OpenAPI specification
      description: Returns this OpenAPI specification in JSON format
      operationId: getOpenApiSpec
      responses:
        '200':
          description: OpenAPI specification
          content:
            application/json:
              schema:
                type: object

  /api/v1/docs:
    get:
      tags:
        - Discovery
      summary: API documentation (Swagger UI)
      description: Interactive API documentation using Swagger UI
      operationId: swaggerUI
      responses:
        '200':
          description: Swagger UI HTML page
          content:
            text/html:
              schema:
                type: string

  # Sharing Endpoints
  /api/v1/share:
    post:
      tags:
        - Sharing
      summary: Share a belief
      description: |
        Share a belief with a specific recipient. Creates a share record
        with optional policy settings for access control.
      operationId: shareBelief
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareBeliefRequest'
            example:
              belief_id: "550e8400-e29b-41d4-a716-446655440000"
              recipient_did: "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
              policy:
                level: direct
                enforcement: cryptographic
                recipients:
                  - "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
      responses:
        '200':
          description: Belief shared successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareBeliefResponse'
              example:
                success: true
                share_id: "123e4567-e89b-12d3-a456-426614174000"
                consent_chain_id: "789e0123-e45b-67d8-a901-234567890abc"
                encrypted_for: "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
                created_at: "2025-02-03T12:00:00Z"
        '400':
          description: Invalid request (validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/shares:
    get:
      tags:
        - Sharing
      summary: List shares
      description: |
        List shares with optional filters. Returns shares matching the
        specified criteria.
      operationId: listShares
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      parameters:
        - name: sharer_did
          in: query
          schema:
            type: string
          description: Filter by sharer DID
        - name: recipient_did
          in: query
          schema:
            type: string
          description: Filter by recipient DID
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          description: Maximum number of results
        - name: revoked
          in: query
          schema:
            type: boolean
            default: false
          description: Include revoked shares
      responses:
        '200':
          description: List of shares
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListSharesResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/shares/{id}:
    get:
      tags:
        - Sharing
      summary: Get share details
      description: Returns detailed information about a specific share.
      operationId: getShare
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Share UUID
      responses:
        '200':
          description: Share details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetShareResponse'
        '404':
          description: Share not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/shares/{id}/revoke:
    post:
      tags:
        - Sharing
      summary: Revoke a share
      description: |
        Revoke an existing share. Only the original sharer can revoke.
        Creates a revocation record and notifies affected recipients.
      operationId: revokeShare
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Share UUID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeShareRequest'
            example:
              reason: "Access no longer needed"
      responses:
        '200':
          description: Share revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokeShareResponse'
              example:
                success: true
                share_id: "123e4567-e89b-12d3-a456-426614174000"
                consent_chain_id: "789e0123-e45b-67d8-a901-234567890abc"
                revoked_at: "2025-02-03T14:00:00Z"
                affected_recipients:
                  - "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
        '400':
          description: Invalid request or already revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied (not the original sharer)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Share not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict (share already revoked)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Notification Endpoints
  /api/v1/notifications:
    get:
      tags:
        - Notifications
      summary: List pending notifications
      description: |
        Returns pending notifications for a specific recipient.
        Notifications include share events, revocations, and other
        system events.
      operationId: listNotifications
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      parameters:
        - name: recipient_did
          in: query
          required: true
          schema:
            type: string
          description: The DID of the recipient
      responses:
        '200':
          description: List of pending notifications
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListNotificationsResponse'
              example:
                success: true
                notifications:
                  - id: "456e7890-e12b-34d5-a678-901234567890"
                    recipient_did: "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
                    notification_type: "share_received"
                    payload:
                      share_id: "123e4567-e89b-12d3-a456-426614174000"
                      sharer_did: "did:key:z6MkiTBz1ymuepAQ4HEHYSF1H8quG5GLVVQR3djdX3mDooWp"
                    created_at: "2025-02-03T12:00:00Z"
                    acknowledged_at: null
                count: 1
        '400':
          description: Missing recipient_did parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/notifications/{id}/acknowledge:
    post:
      tags:
        - Notifications
      summary: Acknowledge a notification
      description: |
        Mark a notification as acknowledged. The recipient_did in the
        request body must match the notification's recipient.
      operationId: acknowledgeNotification
      security:
        - bearerAuth: []
        - oauth2: [mcp:tools]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Notification UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcknowledgeNotificationRequest'
            example:
              recipient_did: "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
      responses:
        '200':
          description: Notification acknowledged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcknowledgeNotificationResponse'
              example:
                success: true
                notification_id: "456e7890-e12b-34d5-a678-901234567890"
                acknowledged: true
        '400':
          description: Invalid request (missing recipient_did)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied (not the notification recipient)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Notification not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Sharing service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Legacy Bearer token authentication
    oauth2:
      type: oauth2
      description: OAuth 2.1 with PKCE
      flows:
        authorizationCode:
          authorizationUrl: /api/v1/oauth/authorize
          tokenUrl: /api/v1/oauth/token
          scopes:
            mcp:tools: Access to MCP tools
            mcp:resources: Access to MCP resources
            mcp:prompts: Access to MCP prompts
            mcp:access: Full access to all tools and REST endpoints
            substrate:read: Read access to knowledge substrate (beliefs, entities, tensions, trust)
            substrate:write: Write access to knowledge substrate (create/supersede beliefs, resolve tensions)
            vkb:read: Read access to VKB (sessions, exchanges, patterns, insights)
            vkb:write: Write access to VKB (create sessions, add exchanges, record patterns)

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RestError'
          example:
            success: false
            error:
              code: AUTH_MISSING_TOKEN
              message: "Missing or invalid authentication token"
    Forbidden:
      description: Insufficient scope for this operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RestError'
          example:
            success: false
            error:
              code: FORBIDDEN_INSUFFICIENT_PERMISSION
              message: "Insufficient scope. Required: substrate:read"

  schemas:
    # Standardized REST error format
    RestError:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code (e.g., VALIDATION_MISSING_FIELD)
            message:
              type: string
              description: Human-readable error message

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean

    # Substrate schemas
    CreateBeliefRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: The belief content
        confidence:
          type: object
          description: 'Confidence dimensions (e.g., {"overall": 0.8})'
          additionalProperties:
            type: number
        domain_path:
          type: array
          items:
            type: string
          description: Hierarchical domain classification
        source_type:
          type: string
          enum: [document, conversation, inference, observation, user_input]
        source_ref:
          type: string
          description: Reference to source (URL, session_id, etc.)
        opt_out_federation:
          type: boolean
          default: false
          description: If true, belief will not be shared via federation
        entities:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
              role:
                type: string
                enum: [subject, object, context]
          description: Entities to link (created if not exist)
        visibility:
          type: string
          enum: [private, federated]
          default: private
        sharing_intent:
          type: string

    SupersedeBeliefRequest:
      type: object
      required:
        - new_content
        - reason
      properties:
        new_content:
          type: string
          description: Updated belief content
        reason:
          type: string
          description: Why the belief is being superseded
        confidence:
          type: object
          description: Confidence for the new belief
          additionalProperties:
            type: number

    ResolveTensionRequest:
      type: object
      required:
        - resolution
        - action
      properties:
        resolution:
          type: string
          description: Explanation of how the tension was resolved
        action:
          type: string
          enum: [supersede_a, supersede_b, keep_both, archive_both]
          description: What to do with the conflicting beliefs

    BeliefListResponse:
      type: object
      properties:
        success:
          type: boolean
        beliefs:
          type: array
          items:
            type: object

    BeliefSearchResponse:
      type: object
      properties:
        success:
          type: boolean
        results:
          type: array
          items:
            type: object

    BeliefResponse:
      type: object
      properties:
        success:
          type: boolean
        belief:
          type: object

    ConfidenceExplainResponse:
      type: object
      properties:
        success:
          type: boolean
        overall:
          type: number

    EntityListResponse:
      type: object
      properties:
        success:
          type: boolean
        entities:
          type: array
          items:
            type: object

    EntityResponse:
      type: object
      properties:
        success:
          type: boolean
        entity:
          type: object

    TensionListResponse:
      type: object
      properties:
        success:
          type: boolean
        tensions:
          type: array
          items:
            type: object

    TrustCheckResponse:
      type: object
      properties:
        success:
          type: boolean
        trusted_entities:
          type: array
          items:
            type: object

    # VKB schemas
    CreateSessionRequest:
      type: object
      required:
        - platform
      properties:
        platform:
          type: string
          enum: [claude-code, api, slack, claude-web, claude-desktop, claude-mobile, openclaw]
          description: Platform this session is on
        project_context:
          type: string
          description: Project or topic context
        external_room_id:
          type: string
          description: Room/channel ID for chat platforms
        claude_session_id:
          type: string
          description: Claude Code session ID for resume
        metadata:
          type: object
          description: Additional session metadata

    EndSessionRequest:
      type: object
      properties:
        summary:
          type: string
          description: Session summary
        themes:
          type: array
          items:
            type: string
          description: Key themes from session
        status:
          type: string
          enum: [completed, abandoned]
          default: completed

    AddExchangeRequest:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant, system]
          description: Role of the speaker
        content:
          type: string
          description: Message content
        tokens_approx:
          type: integer
          description: Approximate token count
        tool_uses:
          type: array
          items:
            type: object
          description: Tools used in this turn

    ExtractInsightRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: The insight content
        domain_path:
          type: array
          items:
            type: string
          description: Domain classification
        confidence:
          type: object
          description: Confidence dimensions
          additionalProperties:
            type: number
        entities:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
              role:
                type: string
          description: Entities to link

    CreatePatternRequest:
      type: object
      required:
        - type
        - description
      properties:
        type:
          type: string
          description: Pattern type (e.g., topic_recurrence, preference, working_style)
        description:
          type: string
          description: What the pattern is
        evidence:
          type: array
          items:
            type: string
          description: Session IDs as evidence
        confidence:
          type: number
          default: 0.5
          minimum: 0
          maximum: 1
          description: Initial confidence score

    ReinforcePatternRequest:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
          description: Session that supports this pattern

    SessionResponse:
      type: object
      properties:
        success:
          type: boolean
        session:
          type: object

    SessionListResponse:
      type: object
      properties:
        success:
          type: boolean
        sessions:
          type: array
          items:
            type: object

    ExchangeResponse:
      type: object
      properties:
        success:
          type: boolean
        exchange:
          type: object

    ExchangeListResponse:
      type: object
      properties:
        success:
          type: boolean
        exchanges:
          type: array
          items:
            type: object

    InsightResponse:
      type: object
      properties:
        success:
          type: boolean
        belief_id:
          type: string
          format: uuid

    InsightListResponse:
      type: object
      properties:
        success:
          type: boolean
        insights:
          type: array
          items:
            type: object

    PatternResponse:
      type: object
      properties:
        success:
          type: boolean
        pattern:
          type: object

    PatternListResponse:
      type: object
      properties:
        success:
          type: boolean
        patterns:
          type: array
          items:
            type: object

    ServerInfo:
      type: object
      properties:
        server:
          type: string
          description: Server name
        version:
          type: string
          description: Server version
        apiVersion:
          type: string
          description: API version
        protocol:
          type: string
          description: Protocol name
        protocolVersion:
          type: string
          description: MCP protocol version
        transport:
          type: string
          description: Transport type
        tools:
          type: object
          properties:
            substrate:
              type: integer
            vkb:
              type: integer
            total:
              type: integer
        endpoints:
          type: object
          additionalProperties:
            type: string
        authentication:
          type: object
          properties:
            methods:
              type: array
              items:
                type: string
            oauth:
              type: object
              additionalProperties:
                type: string

    HealthResponse:
      type: object
      required:
        - status
        - server
        - version
      properties:
        status:
          type: string
          enum: [healthy, degraded]
        server:
          type: string
        version:
          type: string
        database:
          type: string

    JsonRpcRequest:
      type: object
      required:
        - jsonrpc
        - method
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        method:
          type: string
          description: The method to call
        params:
          type: object
          description: Method parameters
        id:
          oneOf:
            - type: string
            - type: integer
          description: Request ID (omit for notifications)

    JsonRpcResponse:
      type: object
      required:
        - jsonrpc
        - id
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        result:
          description: Method result (present on success)
        error:
          $ref: '#/components/schemas/JsonRpcErrorObject'
        id:
          oneOf:
            - type: string
            - type: integer
            - type: 'null'

    JsonRpcError:
      type: object
      required:
        - jsonrpc
        - error
        - id
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        error:
          $ref: '#/components/schemas/JsonRpcErrorObject'
        id:
          oneOf:
            - type: string
            - type: integer
            - type: 'null'

    JsonRpcErrorObject:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          description: |
            Error codes:
            - -32700: Parse error
            - -32600: Invalid request
            - -32601: Method not found
            - -32602: Invalid params
            - -32603: Internal error
            - -32001: Unauthorized
            - -32002: Rate limited
        message:
          type: string
        data:
          description: Additional error data

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        error_description:
          type: string
        success:
          type: boolean
          default: false

    OAuthError:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          enum:
            - invalid_request
            - invalid_client
            - invalid_grant
            - unauthorized_client
            - unsupported_grant_type
            - invalid_scope
            - unsupported_response_type
            - invalid_redirect_uri
        error_description:
          type: string

    ProtectedResourceMetadata:
      type: object
      properties:
        resource:
          type: string
          format: uri
        authorization_servers:
          type: array
          items:
            type: string
            format: uri
        scopes_supported:
          type: array
          items:
            type: string
        bearer_methods_supported:
          type: array
          items:
            type: string
        resource_documentation:
          type: string
          format: uri

    AuthorizationServerMetadata:
      type: object
      properties:
        issuer:
          type: string
          format: uri
        authorization_endpoint:
          type: string
          format: uri
        token_endpoint:
          type: string
          format: uri
        registration_endpoint:
          type: string
          format: uri
        scopes_supported:
          type: array
          items:
            type: string
        response_types_supported:
          type: array
          items:
            type: string
        grant_types_supported:
          type: array
          items:
            type: string
        token_endpoint_auth_methods_supported:
          type: array
          items:
            type: string
        code_challenge_methods_supported:
          type: array
          items:
            type: string

    ClientRegistrationRequest:
      type: object
      required:
        - redirect_uris
      properties:
        redirect_uris:
          type: array
          items:
            type: string
            format: uri
        client_name:
          type: string
        grant_types:
          type: array
          items:
            type: string
          default: [authorization_code, refresh_token]
        response_types:
          type: array
          items:
            type: string
          default: [code]
        scope:
          type: string
          default: mcp:tools mcp:resources

    ClientRegistrationResponse:
      type: object
      properties:
        client_id:
          type: string
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        grant_types:
          type: array
          items:
            type: string
        response_types:
          type: array
          items:
            type: string
        scope:
          type: string
        client_id_issued_at:
          type: integer

    AuthorizationCodeGrant:
      type: object
      required:
        - grant_type
        - code
        - redirect_uri
        - client_id
        - code_verifier
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
        code:
          type: string
        redirect_uri:
          type: string
          format: uri
        client_id:
          type: string
        code_verifier:
          type: string
          description: PKCE code verifier

    RefreshTokenGrant:
      type: object
      required:
        - grant_type
        - refresh_token
      properties:
        grant_type:
          type: string
          enum: [refresh_token]
        refresh_token:
          type: string
        client_id:
          type: string

    TokenResponse:
      type: object
      required:
        - access_token
        - token_type
      properties:
        access_token:
          type: string
        token_type:
          type: string
          enum: [Bearer]
        expires_in:
          type: integer
          description: Token lifetime in seconds
        refresh_token:
          type: string
        scope:
          type: string

    DIDDocument:
      type: object
      required:
        - "@context"
        - id
      properties:
        "@context":
          type: array
          items:
            type: string
        id:
          type: string
          description: DID identifier
        verificationMethod:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              type:
                type: string
              controller:
                type: string
              publicKeyMultibase:
                type: string
        authentication:
          type: array
          items:
            type: string
        assertionMethod:
          type: array
          items:
            type: string
        service:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              type:
                type: string
              serviceEndpoint:
                type: string
        "vfp:capabilities":
          type: array
          items:
            type: string
        "vfp:protocolVersion":
          type: string
        "vfp:profile":
          type: object
          properties:
            name:
              type: string
            domains:
              type: array
              items:
                type: string

    TrustAnchorsResponse:
      type: object
      properties:
        trust_anchors:
          type: array
          items:
            type: object
            properties:
              did:
                type: string
              trust_level:
                type: string
              domains:
                type: array
                items:
                  type: string
              trust_score:
                type: number
              relationship_started_at:
                type: string
                format: date-time
        updated_at:
          type: string
          format: date-time

    FederationStatus:
      type: object
      properties:
        node:
          type: object
          properties:
            did:
              type: string
            name:
              type: string
            capabilities:
              type: array
              items:
                type: string
            protocol_version:
              type: string
        federation:
          type: object
          properties:
            nodes:
              type: object
              properties:
                total:
                  type: integer
                by_status:
                  type: object
                  additionalProperties:
                    type: integer
            sync:
              type: object
              properties:
                active_peers:
                  type: integer
                beliefs_sent:
                  type: integer
                beliefs_received:
                  type: integer
            beliefs:
              type: object
              properties:
                local:
                  type: integer
                federated:
                  type: integer

    CorroborationResponse:
      type: object
      properties:
        success:
          type: boolean
        belief_id:
          type: string
          format: uuid
        corroboration_count:
          type: integer
        confidence_corroboration:
          type: number
          minimum: 0
          maximum: 1
        corroborating_sources:
          type: array
          items:
            type: object
            properties:
              source_did:
                type: string
              similarity:
                type: number
              corroborated_at:
                type: string
                format: date-time
        confidence_label:
          type: string
          enum:
            - uncorroborated
            - single corroboration
            - moderately corroborated
            - well corroborated
            - highly corroborated

    MostCorroboratedResponse:
      type: object
      properties:
        success:
          type: boolean
        beliefs:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              content:
                type: string
              corroboration_count:
                type: integer
              confidence_corroboration:
                type: number
              sources:
                type: array
                items:
                  type: object
              domain_path:
                type: array
                items:
                  type: string
        total_count:
          type: integer

    DeletionResponse:
      type: object
      properties:
        success:
          type: boolean
        tombstone_id:
          type: string
          format: uuid
        deleted_counts:
          type: object
          properties:
            beliefs:
              type: integer
            sessions:
              type: integer
            patterns:
              type: integer
            entities:
              type: integer
        completed_at:
          type: string
          format: date-time

    VerificationReport:
      type: object
      properties:
        tombstone_id:
          type: string
          format: uuid
        user_id:
          type: string
        deletion_reason:
          type: string
        deleted_at:
          type: string
          format: date-time
        verification_hash:
          type: string
        items_deleted:
          type: object
        federation_propagated:
          type: boolean

    # Sharing Schemas
    SharePolicy:
      type: object
      description: Policy settings for a share
      properties:
        level:
          type: string
          enum:
            - direct
            - transitive
          description: Share level (direct = recipient only, transitive = can reshare)
        enforcement:
          type: string
          enum:
            - cryptographic
            - policy
          description: How the policy is enforced
        recipients:
          type: array
          items:
            type: string
          description: List of allowed recipient DIDs

    ShareBeliefRequest:
      type: object
      required:
        - belief_id
        - recipient_did
      properties:
        belief_id:
          type: string
          format: uuid
          description: UUID of the belief to share
        recipient_did:
          type: string
          description: DID of the recipient
        policy:
          $ref: '#/components/schemas/SharePolicy'

    ShareBeliefResponse:
      type: object
      properties:
        success:
          type: boolean
        share_id:
          type: string
          format: uuid
          description: UUID of the created share
        consent_chain_id:
          type: string
          format: uuid
          description: UUID of the consent chain
        encrypted_for:
          type: string
          description: DID the share is encrypted for
        created_at:
          type: string
          format: date-time

    Share:
      type: object
      description: A share record
      properties:
        id:
          type: string
          format: uuid
        consent_chain_id:
          type: string
          format: uuid
        recipient_did:
          type: string
        created_at:
          type: string
          format: date-time
        accessed_at:
          type: string
          format: date-time
          nullable: true

    ListSharesResponse:
      type: object
      properties:
        success:
          type: boolean
        shares:
          type: array
          items:
            $ref: '#/components/schemas/Share'
        count:
          type: integer

    GetShareResponse:
      type: object
      properties:
        success:
          type: boolean
        share:
          $ref: '#/components/schemas/Share'

    RevokeShareRequest:
      type: object
      properties:
        reason:
          type: string
          description: Optional reason for revocation

    RevokeShareResponse:
      type: object
      properties:
        success:
          type: boolean
        share_id:
          type: string
          format: uuid
        consent_chain_id:
          type: string
          format: uuid
        revoked_at:
          type: string
          format: date-time
        affected_recipients:
          type: array
          items:
            type: string
          description: List of DIDs affected by the revocation

    # Notification Schemas
    Notification:
      type: object
      description: A notification record
      properties:
        id:
          type: string
          format: uuid
        recipient_did:
          type: string
        notification_type:
          type: string
          description: Type of notification (e.g., share_received, share_revoked)
        payload:
          type: object
          description: Notification-specific payload data
        created_at:
          type: string
          format: date-time
        acknowledged_at:
          type: string
          format: date-time
          nullable: true

    ListNotificationsResponse:
      type: object
      properties:
        success:
          type: boolean
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        count:
          type: integer

    AcknowledgeNotificationRequest:
      type: object
      required:
        - recipient_did
      properties:
        recipient_did:
          type: string
          description: DID of the notification recipient (for authorization)

    AcknowledgeNotificationResponse:
      type: object
      properties:
        success:
          type: boolean
        notification_id:
          type: string
          format: uuid
        acknowledged:
          type: boolean
