openapi: 3.1.0
info:
  title: Valence API
  version: 1.1.2
  description: |
    Personal knowledge substrate for AI agents - REST API for sources, articles, and provenance.
    
    ## Authentication
    
    All endpoints require Bearer token authentication:
    
    ```
    Authorization: Bearer <token>
    ```
    
    Tokens grant either `substrate:read` or `substrate:write` scope.
  contact:
    name: Valence GitHub
    url: https://github.com/ourochronos/valence
  license:
    name: MIT
    url: https://github.com/ourochronos/valence/blob/main/LICENSE

servers:
  - url: http://127.0.0.1:8420/api/v1
    description: Local development server
  - url: https://your-server.example.com/api/v1
    description: Production server (configure as needed)

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Token
      description: Bearer token from Valence token store

  schemas:
    Source:
      type: object
      required:
        - id
        - content
        - source_type
        - fingerprint
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique source identifier
        content:
          type: string
          description: Raw source content
        source_type:
          type: string
          enum: [document, conversation, web, code, observation, tool_output, user_input]
          description: Type of source material
        title:
          type: string
          nullable: true
          description: Human-readable title
        url:
          type: string
          nullable: true
          description: Canonical URL for web sources
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Arbitrary JSON metadata
        fingerprint:
          type: string
          description: Content hash for deduplication
        created_at:
          type: string
          format: date-time
          description: Timestamp of source creation
        embedding:
          type: array
          items:
            type: number
          nullable: true
          description: Vector embedding (optional)

    Article:
      type: object
      required:
        - id
        - content
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique article identifier
        content:
          type: string
          description: Article content (synthesized knowledge)
        title:
          type: string
          nullable: true
          description: Article title
        status:
          type: string
          enum: [active, superseded, deprecated]
          description: Article lifecycle status
        author_type:
          type: string
          enum: [system, operator, agent]
          description: Authorship type
        domain_path:
          type: array
          items:
            type: string
          nullable: true
          description: Domain hierarchy tags
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
          nullable: true
        superseded_by:
          type: string
          format: uuid
          nullable: true
          description: ID of article that supersedes this one
        embedding:
          type: array
          items:
            type: number
          nullable: true
          description: Vector embedding for semantic search

    ProvenanceLink:
      type: object
      required:
        - article_id
        - source_id
        - relationship
        - linked_at
      properties:
        article_id:
          type: string
          format: uuid
        source_id:
          type: string
          format: uuid
        relationship:
          type: string
          enum: [supports, contradicts, references, derived_from]
          description: Type of provenance relationship
        notes:
          type: string
          nullable: true
          description: Optional notes about the relationship
        linked_at:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          nullable: true

  responses:
    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized
            message: Invalid or missing authentication token

    Forbidden:
      description: Insufficient permissions for requested operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: forbidden
            message: Insufficient scope for this operation

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: not_found
            message: Resource not found

    BadRequest:
      description: Invalid request payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: bad_request
            message: Missing required field 'content'

    Conflict:
      description: Resource conflict (duplicate fingerprint)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: conflict
            message: Source with this fingerprint already exists

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: internal_error
            message: An unexpected error occurred

paths:
  # =========================================================================
  # Sources
  # =========================================================================
  /sources:
    post:
      summary: Ingest a new source
      operationId: createSource
      tags:
        - Sources
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
                - source_type
              properties:
                content:
                  type: string
                  description: Raw source content
                source_type:
                  type: string
                  enum: [document, conversation, web, code, observation, tool_output, user_input]
                title:
                  type: string
                  description: Optional human-readable title
                url:
                  type: string
                  description: Optional canonical URL
                metadata:
                  type: object
                  additionalProperties: true
                  description: Optional arbitrary JSON metadata
            example:
              content: "PostgreSQL is a powerful open-source relational database."
              source_type: "document"
              title: "PostgreSQL Overview"
              metadata:
                author: "Example User"
      responses:
        '201':
          description: Source created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  source:
                    $ref: '#/components/schemas/Source'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      summary: List sources
      operationId: listSources
      tags:
        - Sources
      security:
        - bearerAuth: []
      parameters:
        - name: source_type
          in: query
          schema:
            type: string
            enum: [document, conversation, web, code, observation, tool_output, user_input]
          description: Filter by source type
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
          description: Maximum number of results
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: List of sources
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sources:
                    type: array
                    items:
                      $ref: '#/components/schemas/Source'
                  total_count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /sources/{source_id}:
    get:
      summary: Get source by ID
      operationId: getSource
      tags:
        - Sources
      security:
        - bearerAuth: []
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Source UUID
      responses:
        '200':
          description: Source details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  source:
                    $ref: '#/components/schemas/Source'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /sources/search:
    post:
      summary: Search sources by content
      operationId: searchSources
      tags:
        - Sources
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: Search query
                limit:
                  type: integer
                  default: 20
                  description: Maximum results
            example:
              query: "PostgreSQL performance"
              limit: 10
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sources:
                    type: array
                    items:
                      $ref: '#/components/schemas/Source'
                  total_count:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  # =========================================================================
  # Articles
  # =========================================================================
  /articles:
    post:
      summary: Create a new article
      operationId: createArticle
      tags:
        - Articles
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  description: Article content
                title:
                  type: string
                  description: Optional title
                source_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Source IDs to link as provenance
                author_type:
                  type: string
                  enum: [system, operator, agent]
                  default: system
                domain_path:
                  type: array
                  items:
                    type: string
                  description: Domain hierarchy tags
            example:
              content: "PostgreSQL uses MVCC for concurrency control..."
              title: "PostgreSQL Concurrency Model"
              author_type: "agent"
              domain_path: ["databases", "postgresql"]
      responses:
        '201':
          description: Article created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  article:
                    $ref: '#/components/schemas/Article'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /articles/search:
    post:
      summary: Search articles
      operationId: searchArticles
      tags:
        - Articles
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: Search query
                limit:
                  type: integer
                  default: 10
                  maximum: 50
                domain_filter:
                  type: array
                  items:
                    type: string
                  description: Filter by domain path
            example:
              query: "PostgreSQL MVCC"
              limit: 5
              domain_filter: ["databases"]
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  articles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Article'
                  total_count:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /articles/{article_id}:
    get:
      summary: Get article by ID
      operationId: getArticle
      tags:
        - Articles
      security:
        - bearerAuth: []
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: include_provenance
          in: query
          schema:
            type: boolean
            default: false
          description: Include provenance sources
      responses:
        '200':
          description: Article details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  article:
                    $ref: '#/components/schemas/Article'
                  provenance:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProvenanceLink'
                    description: Included if include_provenance=true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update article content
      operationId: updateArticle
      tags:
        - Articles
      security:
        - bearerAuth: []
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  description: Updated content
                source_id:
                  type: string
                  format: uuid
                  description: Optional source ID for provenance
      responses:
        '200':
          description: Article updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  article:
                    $ref: '#/components/schemas/Article'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # =========================================================================
  # Provenance
  # =========================================================================
  /articles/{article_id}/provenance:
    get:
      summary: Get article provenance
      operationId: getProvenance
      tags:
        - Provenance
      security:
        - bearerAuth: []
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provenance links
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  provenance:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProvenanceLink'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /articles/{article_id}/provenance/link:
    post:
      summary: Link a source to an article
      operationId: linkProvenance
      tags:
        - Provenance
      security:
        - bearerAuth: []
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - source_id
                - relationship
              properties:
                source_id:
                  type: string
                  format: uuid
                relationship:
                  type: string
                  enum: [supports, contradicts, references, derived_from]
                notes:
                  type: string
            example:
              source_id: "550e8400-e29b-41d4-a716-446655440000"
              relationship: "supports"
              notes: "Primary source for MVCC explanation"
      responses:
        '201':
          description: Provenance link created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /articles/{article_id}/provenance/trace:
    post:
      summary: Trace a claim to sources
      operationId: traceClaim
      tags:
        - Provenance
      security:
        - bearerAuth: []
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - claim_text
              properties:
                claim_text:
                  type: string
                  description: Text of claim to trace
            example:
              claim_text: "PostgreSQL uses MVCC"
      responses:
        '200':
          description: Traced sources
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sources:
                    type: array
                    items:
                      $ref: '#/components/schemas/Source'
                  count:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  # =========================================================================
  # System
  # =========================================================================
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags:
        - System
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded]
                  server:
                    type: string
                  version:
                    type: string
                  database:
                    type: string
        '503':
          description: Service is degraded or unhealthy

  /stats:
    get:
      summary: Get system statistics
      operationId: getStats
      tags:
        - System
      security:
        - bearerAuth: []
      responses:
        '200':
          description: System statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  articles:
                    type: object
                    properties:
                      total:
                        type: integer
                      active:
                        type: integer
                  sources:
                    type: object
                    properties:
                      total:
                        type: integer
                  embeddings:
                    type: object
                    properties:
                      coverage_pct:
                        type: number
                      total:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

tags:
  - name: Sources
    description: Source ingestion and retrieval
  - name: Articles
    description: Article creation and search
  - name: Provenance
    description: Source-to-article provenance tracking
  - name: System
    description: Health and statistics
