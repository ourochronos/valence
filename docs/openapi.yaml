openapi: 3.1.0
info:
  title: Valence API
  version: 2.0.0
  description: |
    Personal knowledge substrate for AI agents â€” REST API for sources, articles,
    provenance, contentions, sessions, and admin operations.

    ## Authentication

    All endpoints require Bearer token authentication:

    ```
    Authorization: Bearer <token>
    ```

    Tokens grant either `substrate:read` or `substrate:write` scope.
  contact:
    name: Valence GitHub
    url: https://github.com/ourochronos/valence
  license:
    name: MIT
    url: https://github.com/ourochronos/valence/blob/main/LICENSE

servers:
  - url: http://127.0.0.1:8420/api/v1
    description: Local development server

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  schemas:
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    Source:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        source_type:
          type: string
          enum: [document, conversation, web, code, observation, tool_output, user_input]
        title:
          type: string
        url:
          type: string
        reliability:
          type: number
        metadata:
          type: object
        created_at:
          type: string
          format: date-time

    Article:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        title:
          type: string
        confidence:
          type: number
        domain_path:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, archived, superseded]
        version:
          type: integer
        usage_score:
          type: number
        corroboration_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        platform:
          type: string
        agent_id:
          type: string
        status:
          type: string
          enum: [active, completed, expired]
        message_count:
          type: integer
        created_at:
          type: string
          format: date-time

paths:
  # ===========================================================================
  # Health & Docs
  # ===========================================================================
  /health:
    get:
      summary: Health check
      tags: [System]
      security: []
      responses:
        "200":
          description: Server is healthy

  /stats:
    get:
      summary: Aggregate database statistics
      tags: [System]
      parameters:
        - name: output
          in: query
          schema:
            type: string
            enum: [json, text]
      responses:
        "200":
          description: Statistics object

  /metrics:
    get:
      summary: Prometheus-format metrics
      tags: [System]
      responses:
        "200":
          description: Prometheus text metrics

  # ===========================================================================
  # Search (unified retrieval)
  # ===========================================================================
  /search:
    get:
      summary: Unified knowledge search
      description: |
        Ranked hybrid retrieval across articles and optionally sources.
        Uses full-text search + semantic similarity with RRF fusion.
      tags: [Search]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: include_sources
          in: query
          schema:
            type: boolean
            default: false
        - name: session_id
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Ranked search results

  # ===========================================================================
  # Sources
  # ===========================================================================
  /sources:
    get:
      summary: List sources
      tags: [Sources]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: source_type
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of sources
    post:
      summary: Ingest a new source
      tags: [Sources]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content, source_type]
              properties:
                content:
                  type: string
                source_type:
                  type: string
                  enum: [document, conversation, web, code, observation, tool_output, user_input]
                title:
                  type: string
                url:
                  type: string
                metadata:
                  type: object
      responses:
        "200":
          description: Ingested source

  /sources/search:
    post:
      summary: Full-text search over sources
      tags: [Sources]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                limit:
                  type: integer
                  default: 20
      responses:
        "200":
          description: Search results

  /sources/{source_id}:
    get:
      summary: Get source by ID
      tags: [Sources]
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Source details
    delete:
      summary: Delete a source
      tags: [Sources]
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Source deleted

  /sources/{source_id}/index:
    post:
      summary: Build tree index for a source
      description: Uses LLM to generate hierarchical tree structure with character offsets.
      tags: [Sources]
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Tree index built

  /sources/{source_id}/tree:
    get:
      summary: Get tree index for a source
      tags: [Sources]
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Tree index structure

  /sources/{source_id}/region:
    get:
      summary: Get text region from a source by character offsets
      tags: [Sources]
      parameters:
        - name: source_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: start
          in: query
          required: true
          schema:
            type: integer
        - name: end
          in: query
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Text region content

  # ===========================================================================
  # Articles
  # ===========================================================================
  /articles:
    get:
      summary: Search articles
      tags: [Articles]
      parameters:
        - name: query
          in: query
          schema:
            type: string
        - name: domain
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Article search results
    post:
      summary: Create an article
      tags: [Articles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                title:
                  type: string
                domain_path:
                  type: array
                  items:
                    type: string
                source_ids:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Created article

  /articles/search:
    post:
      summary: Search articles (POST variant)
      tags: [Articles]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                domain:
                  type: string
                limit:
                  type: integer
      responses:
        "200":
          description: Article search results

  /articles/compile:
    post:
      summary: Compile sources into an article via LLM
      tags: [Articles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source_ids]
              properties:
                source_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                title_hint:
                  type: string
      responses:
        "200":
          description: Compiled article

  /articles/merge:
    post:
      summary: Merge two articles
      tags: [Articles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [article_id_a, article_id_b]
              properties:
                article_id_a:
                  type: string
                  format: uuid
                article_id_b:
                  type: string
                  format: uuid
      responses:
        "200":
          description: Merged article

  /articles/{article_id}:
    get:
      summary: Get article by ID
      tags: [Articles]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: include_provenance
          in: query
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Article details
    put:
      summary: Update an article
      tags: [Articles]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                source_id:
                  type: string
                  format: uuid
      responses:
        "200":
          description: Updated article

  /articles/{article_id}/split:
    post:
      summary: Split an oversized article
      tags: [Articles]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Split result (original + new article)

  /articles/{article_id}/provenance:
    get:
      summary: Get provenance links for an article
      tags: [Provenance]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Provenance links

  /articles/{article_id}/provenance/link:
    post:
      summary: Link a source to an article
      tags: [Provenance]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source_id, relationship]
              properties:
                source_id:
                  type: string
                  format: uuid
                relationship:
                  type: string
                  enum: [originates, confirms, supersedes, contradicts, contends]
      responses:
        "200":
          description: Link created

  /articles/{article_id}/provenance/trace:
    post:
      summary: Trace a claim to its contributing sources
      tags: [Provenance]
      parameters:
        - name: article_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [claim_text]
              properties:
                claim_text:
                  type: string
      responses:
        "200":
          description: Source attribution rankings

  # ===========================================================================
  # Contentions
  # ===========================================================================
  /contentions:
    get:
      summary: List contentions
      tags: [Contentions]
      parameters:
        - name: article_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [detected, resolved, dismissed]
      responses:
        "200":
          description: List of contentions

  /contentions/detect:
    get:
      summary: Detect potential contradictions via semantic similarity
      tags: [Contentions]
      parameters:
        - name: threshold
          in: query
          schema:
            type: number
            default: 0.85
        - name: auto_record
          in: query
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Detected conflicts

  /contentions/{contention_id}/resolve:
    post:
      summary: Resolve a contention
      tags: [Contentions]
      parameters:
        - name: contention_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [resolution, rationale]
              properties:
                resolution:
                  type: string
                  enum: [supersede_a, supersede_b, accept_both, dismiss]
                rationale:
                  type: string
      responses:
        "200":
          description: Resolved contention

  # ===========================================================================
  # Sessions
  # ===========================================================================
  /sessions:
    get:
      summary: List sessions
      tags: [Sessions]
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: platform
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        "200":
          description: List of sessions
    post:
      summary: Create or update a session
      tags: [Sessions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                platform:
                  type: string
                agent_id:
                  type: string
                external_id:
                  type: string
                metadata:
                  type: object
      responses:
        "200":
          description: Session created/updated

  /sessions/search:
    get:
      summary: Search sessions
      tags: [Sessions]
      parameters:
        - name: query
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Session search results

  /sessions/flush-stale:
    post:
      summary: Flush all stale sessions
      tags: [Sessions]
      responses:
        "200":
          description: Flush results

  /sessions/{session_id}:
    get:
      summary: Get session details
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: include_messages
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Session details
    patch:
      summary: Update session metadata
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                metadata:
                  type: object
      responses:
        "200":
          description: Updated session

  /sessions/{session_id}/messages:
    get:
      summary: Get session messages
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Message list
    post:
      summary: Append messages to session
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [messages]
              properties:
                messages:
                  type: array
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                      content:
                        type: string
      responses:
        "200":
          description: Messages appended

  /sessions/{session_id}/flush:
    post:
      summary: Flush session messages to source
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Session flushed

  /sessions/{session_id}/compile:
    post:
      summary: Compile session sources into article
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Compiled article

  /sessions/{session_id}/finalize:
    post:
      summary: Flush + complete + compile session
      tags: [Sessions]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Finalized session

  # ===========================================================================
  # Admin
  # ===========================================================================
  /admin/maintenance:
    post:
      summary: Trigger maintenance operations
      tags: [Admin]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                recompute_scores:
                  type: boolean
                process_queue:
                  type: boolean
                evict_if_over_capacity:
                  type: boolean
                evict_count:
                  type: integer
      responses:
        "200":
          description: Maintenance results

  /admin/forget/{target_type}/{target_id}:
    delete:
      summary: Permanently remove a source or article
      tags: [Admin]
      parameters:
        - name: target_type
          in: path
          required: true
          schema:
            type: string
            enum: [source, article]
        - name: target_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Target forgotten

  /admin/verify-chains:
    get:
      summary: Verify provenance chain integrity
      tags: [Admin]
      responses:
        "200":
          description: Chain verification results

  /admin/embeddings/status:
    get:
      summary: Embedding coverage status
      tags: [Admin]
      responses:
        "200":
          description: Embedding statistics

  /admin/embeddings/backfill:
    post:
      summary: Backfill missing embeddings
      tags: [Admin]
      responses:
        "200":
          description: Backfill results

  /admin/embeddings/migrate:
    post:
      summary: Migrate embeddings to section-based format
      tags: [Admin]
      responses:
        "200":
          description: Migration results

  /config/inference:
    put:
      summary: Configure inference backend
      tags: [Admin]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                backend:
                  type: string
                model:
                  type: string
                base_url:
                  type: string
      responses:
        "200":
          description: Configuration updated
